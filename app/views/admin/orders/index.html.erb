<h1 class="mb-4">All Customer Orders</h1>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <p class="text-muted mb-0">
      Below is a complete list of all orders placed by all customers, including
      order totals, taxes, and product details.
    </p>
  </div>
</div>

<table class="table table-bordered table-hover align-middle">
  <thead class="table-dark">
    <tr>
      <th>Order #</th>
      <th>Customer</th>
      <th>Email</th>
      <th>Date</th>
      <th>Status</th>
      <th>Update</th>
      <th>Subtotal</th>
      <th>Taxes</th>
      <th>Total</th>
      <th>Products</th>
    </tr>
  </thead>

  <tbody>
    <% @orders.each do |order| %>
      <tr>
        <!-- Order ID -->
        <td><%= order.id %></td>

        <!-- Customer Name -->
        <td><%= order.user&.name || "N/A" %></td>

        <!-- Email -->
        <td><%= order.user&.email || "N/A" %></td>

        <!-- Date -->
        <td><%= order.created_at.strftime("%B %d, %Y") %></td>

        <!-- Status Badge -->
        <td>
          <% status_text =
                case order.status
                when "new"
                  "New"
                when "paid"
                  "Paid — Pending Shipping"
                when "paid-shipped"
                  "Paid — Shipped"
                when "shipped"
                  "Shipped"
                else
                  order.status.capitalize
                end %>

          <% badge =
                case order.status
                when "paid-shipped" then "bg-primary"
                when "paid"         then "bg-success"
                when "new"          then "bg-secondary"
                else "bg-dark"
                end %>

          <span class="badge <%= badge %>">
            <%= status_text %>
          </span>
        </td>

        <!-- Update Button -->
        <td>
          <%= button_to "Toggle Shipping",
                toggle_shipping_admin_order_path(order),
                method: :patch,
                class: "btn btn-sm btn-outline-primary" %>
        </td>

        <!-- Subtotal -->
        <td><%= number_to_currency(order.subtotal) %></td>

        <!-- Taxes -->
        <td>
          <strong>GST:</strong> <%= number_to_currency(order.gst_amount) %><br>
          <strong>PST:</strong> <%= number_to_currency(order.pst_amount) %><br>
          <strong>HST:</strong> <%= number_to_currency(order.hst_amount) %>
        </td>

        <!-- Total -->
        <td class="fw-bold">
          <%= number_to_currency(order.total) %>
        </td>

        <!-- Products (Collapsible List) -->
        <td style="width: 260px;">
          <button class="btn btn-sm btn-outline-secondary"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#order-products-<%= order.id %>">
            View Products
          </button>

          <div id="order-products-<%= order.id %>" class="collapse mt-2">
            <ul class="list-group small">
              <% order.order_items.each do |item| %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong><%= item.product.name %></strong><br>
                    Qty: <%= item.quantity %>
                  </div>
                  <span><%= number_to_currency(item.price_at_purchase * item.quantity) %></span>
                </li>
              <% end %>
            </ul>
          </div>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
